import '../database/database_helper.dart';
import '../models/chat_message.dart';
import 'package:uuid/uuid.dart';

class ChatbotService {
  final DatabaseHelper _dbHelper = DatabaseHelper();
  final Uuid _uuid = const Uuid();

  // Save a chat message
  Future<void> saveMessage(ChatMessage message) async {
    await _dbHelper.insert('chat_messages', message.toMap());
  }

  // Get chat history for a user
  Future<List<ChatMessage>> getChatHistory(String userId) async {
    final results = await _dbHelper.query(
      'chat_messages',
      where: 'conversation_id = ?',
      whereArgs: [userId],
      orderBy: 'timestamp ASC',
    );

    return results.map((map) => ChatMessage.fromMap(map)).toList();
  }

  // Get AI response to user message
  Future<String> getAIResponse(String userMessage, String userId) async {
    // This is a simple rule-based chatbot
    // In a real implementation, you would integrate with an AI service like OpenAI, Gemini, etc.
    
    final message = userMessage.toLowerCase().trim();
    
    // Symptom analysis patterns
    if (_containsSymptoms(message)) {
      return _analyzeSymptoms(message);
    }
    
    // Blood pressure related
    if (message.contains('ุถุบุท') || message.contains('pressure')) {
      return _getBloodPressureAdvice(message);
    }
    
    // Blood sugar related
    if (message.contains('ุณูุฑ') || message.contains('sugar') || message.contains('diabetes')) {
      return _getBloodSugarAdvice(message);
    }
    
    // Medication reminders
    if (message.contains('ุฏูุงุก') || message.contains('ุนูุงุฌ') || message.contains('medication')) {
      return _getMedicationAdvice(message);
    }
    
    // Diet and nutrition
    if (message.contains('ุทุนุงู') || message.contains('ุบุฐุงุก') || message.contains('diet') || message.contains('nutrition')) {
      return _getNutritionAdvice(message);
    }
    
    // Exercise and activity
    if (message.contains('ุฑูุงุถุฉ') || message.contains('ุชูุฑูู') || message.contains('exercise') || message.contains('activity')) {
      return _getExerciseAdvice(message);
    }
    
    // General health questions
    if (message.contains('ุตุญุฉ') || message.contains('health')) {
      return _getGeneralHealthAdvice(message);
    }
    
    // Appointment related
    if (message.contains('ููุนุฏ') || message.contains('appointment') || message.contains('ุทุจูุจ')) {
      return _getAppointmentAdvice(message);
    }
    
    // Default response
    return _getDefaultResponse();
  }

  bool _containsSymptoms(String message) {
    final symptoms = [
      'ุตุฏุงุน', 'ุฃูู', 'ุญูู', 'ุณุนุงู', 'ุฏูุฎุฉ', 'ุบุซูุงู', 'ุชุนุจ', 'ุฅุฑูุงู',
      'headache', 'pain', 'fever', 'cough', 'dizziness', 'nausea', 'fatigue'
    ];
    
    return symptoms.any((symptom) => message.contains(symptom));
  }

  String _analyzeSymptoms(String message) {
    final responses = [
      '''ุฃููู ุฃูู ุชุนุงูู ูู ุจุนุถ ุงูุฃุนุฑุงุถ. ุฅููู ุจุนุถ ุงููุตุงุฆุญ ุงูุนุงูุฉ:

๐ **ุชุญููู ุงูุฃุนุฑุงุถ:**
โข ุณุฌู ุงูุฃุนุฑุงุถ ูููุช ุธููุฑูุง
โข ูุงุญุธ ุดุฏุฉ ุงูุฃุนุฑุงุถ ูู 1-10
โข ุฑุงูุจ ุฃู ุนูุงูู ูุญูุฒุฉ

โ๏ธ **ูุชู ุชุณุชุดูุฑ ุงูุทุจูุจ:**
โข ุฅุฐุง ุงุณุชูุฑุช ุงูุฃุนุฑุงุถ ุฃูุซุฑ ูู 3 ุฃูุงู
โข ุฅุฐุง ุงุฒุฏุงุฏุช ุดุฏุฉ ุงูุฃุนุฑุงุถ
โข ุฅุฐุง ุธูุฑุช ุฃุนุฑุงุถ ุฌุฏูุฏุฉ

๐ก **ูุตุงุฆุญ ุนุงูุฉ:**
โข ุงุญุตู ุนูู ุฑุงุญุฉ ูุงููุฉ
โข ุงุดุฑุจ ุงููุซูุฑ ูู ุงููุงุก
โข ุชุฌูุจ ุงูุฅุฌูุงุฏ

โ๏ธ **ุชุฐููุฑ ููู:** ูุฐู ูุตุงุฆุญ ุนุงูุฉ ููุท. ุงุณุชุดุฑ ุทุจูุจู ููุชุดุฎูุต ุงูุฏููู.''',
    ];
    
    return responses.first;
  }

  String _getBloodPressureAdvice(String message) {
    return '''๐ซ **ูุตุงุฆุญ ูุถุบุท ุงูุฏู:**

๐ **ุงูููุงุณ ุงูุตุญูุญ:**
โข ูุณ ุถุบุท ุงูุฏู ูู ููุณ ุงูููุช ููููุงู
โข ุงุณุชุฑุญ 5 ุฏูุงุฆู ูุจู ุงูููุงุณ
โข ุชุฌูุจ ุงููุงูููู ูุจู ุงูููุงุณ ุจุณุงุนุฉ

๐ฅ **ุงููุธุงู ุงูุบุฐุงุฆู:**
โข ููู ูู ุงูููุญ (ุฃูู ูู 6 ุฌุฑุงู ููููุงู)
โข ุฃูุซุฑ ูู ุงูุฎุถุฑูุงุช ูุงูููุงูู
โข ุชุฌูุจ ุงูุฃุทุนูุฉ ุงููุตูุนุฉ

๐โโ๏ธ **ุงููุดุงุท ุงูุจุฏูู:**
โข ุงูุด 30 ุฏูููุฉ ููููุงู
โข ูุงุฑุณ ุชูุงุฑูู ุงูุชููุณ
โข ุชุฌูุจ ุงูุชูุงุฑูู ุงูุดุงูุฉ ุงูููุงุฌุฆุฉ

๐ **ุงูุฃุฏููุฉ:**
โข ุชูุงูู ุงูุฃุฏููุฉ ูู ููุงุนูุฏูุง
โข ูุง ุชุชููู ุนู ุงูุฏูุงุก ุฏูู ุงุณุชุดุงุฑุฉ ุงูุทุจูุจ

ููููู ุชุณุฌูู ููุงุณุงุชู ูู ูุณู "ุงูููุงุณุงุช ุงูุทุจูุฉ" ูู ุงูุชุทุจูู.''';
  }

  String _getBloodSugarAdvice(String message) {
    return '''๐ฉธ **ูุตุงุฆุญ ูุณูุฑ ุงูุฏู:**

๐ **ุงููุฑุงูุจุฉ:**
โข ูุณ ุงูุณูุฑ ุญุณุจ ุชูุฌููุงุช ุทุจูุจู
โข ุณุฌู ุงููุฑุงุกุงุช ูุน ุงูููุช ูุงููุฌุจุงุช
โข ุฑุงูุจ ุฃุนุฑุงุถ ุงูุฎูุงุถ ุฃู ุงุฑุชูุงุน ุงูุณูุฑ

๐ฝ๏ธ **ุงูุชุบุฐูุฉ:**
โข ุชูุงูู ูุฌุจุงุช ููุชุธูุฉ ููุชูุงุฒูุฉ
โข ููู ูู ุงูุณูุฑูุงุช ุงูุจุณูุทุฉ
โข ุฃูุซุฑ ูู ุงูุฃููุงู ูุงูุจุฑูุชูู

โฐ **ุงูุชูููุช:**
โข ูุง ุชููุช ุงููุฌุจุงุช
โข ุชูุงูู ูุฌุจุงุช ุฎูููุฉ ุตุญูุฉ ุนูุฏ ุงูุญุงุฌุฉ
โข ุฑุงูุจ ูุณุชูู ุงูุณูุฑ ูุจู ุงูููู

๐จ **ุนูุงูุงุช ุงูุชุญุฐูุฑ:**
โข ุงูุณูุฑ ุฃูู ูู 70: ุชูุงูู ุดูุฆุงู ุญููุงู ููุฑุงู
โข ุงูุณูุฑ ุฃุนูู ูู 250: ุงุณุชุดุฑ ุงูุทุจูุจ
โข ุฃุนุฑุงุถ ูุซู ุงูุนุทุด ุงูุดุฏูุฏ ุฃู ุงูุชุจูู ุงูููุฑุท

ุงุณุชุฎุฏู ูุณู "ุงูููุงุณุงุช ุงูุทุจูุฉ" ูุชุชุจุน ูุฑุงุกุงุชู.''';
  }

  String _getMedicationAdvice(String message) {
    return '''๐ **ูุตุงุฆุญ ุงูุฃุฏููุฉ:**

โฐ **ุงูููุงุนูุฏ:**
โข ุชูุงูู ุงูุฃุฏููุฉ ูู ููุณ ุงูููุช ููููุงู
โข ุงุณุชุฎุฏู ููุจูุงุช ููุชุฐููุฑ
โข ูุง ุชููุช ุฌุฑุนุงุช

๐ **ุงูุชูุธูู:**
โข ุงุญุชูุธ ุจูุงุฆูุฉ ุจุฌููุน ุฃุฏููุชู
โข ุงุนุฑู ุฃุณูุงุก ุงูุฃุฏููุฉ ูุฌุฑุนุงุชูุง
โข ุฃุฎุจุฑ ุฌููุน ุงูุฃุทุจุงุก ุจุฃุฏููุชู

โ๏ธ **ุงูุฃุนุฑุงุถ ุงูุฌุงูุจูุฉ:**
โข ุฑุงูุจ ุฃู ุฃุนุฑุงุถ ุบูุฑ ุทุจูุนูุฉ
โข ุฃุจูุบ ุทุจูุจู ุนู ุฃู ูุดุงูู
โข ูุง ุชุชููู ุนู ุงูุฏูุงุก ุฏูู ุงุณุชุดุงุฑุฉ

๐ช **ุงูุชุฎุฒูู:**
โข ุงุญูุธ ุงูุฃุฏููุฉ ูู ููุงู ุจุงุฑุฏ ูุฌุงู
โข ุชุญูู ูู ุชูุงุฑูุฎ ุงูุงูุชูุงุก
โข ุงุญุชูุธ ุจุงูุฃุฏููุฉ ูู ุนุจูุงุชูุง ุงูุฃุตููุฉ

ููููู ุงุณุชุฎุฏุงู ูุณู "ุงูููุงู" ูุชุฐููุฑู ุจููุงุนูุฏ ุงูุฃุฏููุฉ.''';
  }

  String _getNutritionAdvice(String message) {
    return '''๐ฅ **ูุตุงุฆุญ ุงูุชุบุฐูุฉ ุงูุตุญูุฉ:**

๐ **ุงูุฃุณุงุณูุงุช:**
โข ุชูุงูู 5 ุญุตุต ูู ุงูุฎุถุฑูุงุช ูุงูููุงูู ููููุงู
โข ุงุฎุชุฑ ุงูุญุจูุจ ุงููุงููุฉ
โข ุฃูุซุฑ ูู ุงูุจุฑูุชูู ุงูุฎุงูู ูู ุงูุฏููู

๐ง **ุงูุชุฑุทูุจ:**
โข ุงุดุฑุจ 8-10 ุฃููุงุจ ูุงุก ููููุงู
โข ููู ูู ุงููุดุฑูุจุงุช ุงูุณูุฑูุฉ
โข ุชุฌูุจ ุงููุญูู ุฃู ููู ููู

๐ง **ูุง ูุฌุจ ุชุฌูุจู:**
โข ุงูุฃุทุนูุฉ ุงููุตูุนุฉ ูุงููุนูุจุฉ
โข ุงูุฏููู ุงููุดุจุนุฉ ูุงููุชุญููุฉ
โข ุงูุณูุฑูุงุช ุงููุถุงูุฉ

โฐ **ุงูุชูููุช:**
โข ุชูุงูู 3 ูุฌุจุงุช ุฑุฆูุณูุฉ ู2 ุฎูููุฉ
โข ูุง ุชููุช ูุฌุจุฉ ุงูุฅูุทุงุฑ
โข ุชุฌูุจ ุงูุฃูู ูุจู ุงูููู ุจุณุงุนุชูู

๐ฝ๏ธ **ุญุฌู ุงูุญุตุต:**
โข ุงุณุชุฎุฏู ุฃุทุจุงู ุฃุตุบุฑ
โข ุงูุถุบ ุจุจุทุก
โข ุชููู ุนูุฏ ุงูุดุนูุฑ ุจุงูุดุจุน''';
  }

  String _getExerciseAdvice(String message) {
    return '''๐โโ๏ธ **ูุตุงุฆุญ ุงููุดุงุท ุงูุจุฏูู:**

โฐ **ุงููุฏู ุงูุฃุณุจูุนู:**
โข 150 ุฏูููุฉ ูู ุงููุดุงุท ุงููุนุชุฏู
โข ุฃู 75 ุฏูููุฉ ูู ุงููุดุงุท ุงูููู
โข ุชูุงุฑูู ุงูููุฉ ูุฑุชูู ุฃุณุจูุนูุงู

๐ถโโ๏ธ **ูููุจุชุฏุฆูู:**
โข ุงุจุฏุฃ ุจุงููุดู 10 ุฏูุงุฆู ููููุงู
โข ุฒุฏ ุงููุฏุฉ ุชุฏุฑูุฌูุงู
โข ุงุฎุชุฑ ุฃูุดุทุฉ ุชุณุชูุชุน ุจูุง

๐ช **ุฃููุงุน ุงูุชูุงุฑูู:**
โข ุชูุงุฑูู ุงูููุจ: ุงููุดูุ ุงูุณุจุงุญุฉุ ุงูุฏุฑุงุฌุฉ
โข ุชูุงุฑูู ุงูููุฉ: ุฑูุน ุงูุฃุซูุงูุ ุชูุงุฑูู ุงูููุงููุฉ
โข ุชูุงุฑูู ุงููุฑููุฉ: ุงูููุบุงุ ุงูุชูุฏุฏ

โ๏ธ **ุงุญุชูุงุทุงุช:**
โข ุงุณุชุดุฑ ุทุจูุจู ูุจู ุจุฏุก ุจุฑูุงูุฌ ุฌุฏูุฏ
โข ุงุจุฏุฃ ุจุจุทุก ูุฒุฏ ุงูุชุฏุฑูุฌ
โข ุชููู ุฅุฐุง ุดุนุฑุช ุจุฃูู ุฃู ุฏูุฎุฉ

๐ฏ **ูุตุงุฆุญ ููุงุณุชูุฑุงุฑ:**
โข ุญุฏุฏ ุฃูุฏุงูุงู ูุงูุนูุฉ
โข ูุงุฑุณ ุงูุฑูุงุถุฉ ูุน ุตุฏูู
โข ุณุฌู ุชูุฏูู''';
  }

  String _getGeneralHealthAdvice(String message) {
    return '''๐ **ูุตุงุฆุญ ุงูุตุญุฉ ุงูุนุงูุฉ:**

๐ด **ุงูููู:**
โข ุงุญุตู ุนูู 7-9 ุณุงุนุงุช ููู ููููุงู
โข ุญุงูุธ ุนูู ููุงุนูุฏ ููู ููุชุธูุฉ
โข ุชุฌูุจ ุงูุดุงุดุงุช ูุจู ุงูููู ุจุณุงุนุฉ

๐งโโ๏ธ **ุฅุฏุงุฑุฉ ุงูุชูุชุฑ:**
โข ูุงุฑุณ ุชูุงุฑูู ุงูุชููุณ ุงูุนููู
โข ุฌุฑุจ ุงูุชุฃูู ุฃู ุงูููุบุง
โข ุฎุตุต ููุชุงู ููููุงูุงุช

๐ฅ **ุงููุญูุตุงุช ุงูุฏูุฑูุฉ:**
โข ุฒุฑ ุทุจูุจู ุจุงูุชุธุงู
โข ุฃุฌุฑ ุงููุญูุตุงุช ุงููุทููุจุฉ
โข ุฑุงูุจ ุงูุนูุงูุงุช ุงูุญูููุฉ

๐ญ **ุงูุนุงุฏุงุช ุงูุตุญูุฉ:**
โข ุชุฌูุจ ุงูุชุฏุฎูู
โข ููู ูู ุงููุญูู
โข ุญุงูุธ ุนูู ูุฒู ุตุญู

๐ค **ุงูุฏุนู ุงูุงุฌุชูุงุนู:**
โข ุญุงูุธ ุนูู ุนูุงูุงุช ุฅูุฌุงุจูุฉ
โข ูุง ุชุชุฑุฏุฏ ูู ุทูุจ ุงููุณุงุนุฏุฉ
โข ุดุงุฑู ูู ุฃูุดุทุฉ ุงุฌุชูุงุนูุฉ''';
  }

  String _getAppointmentAdvice(String message) {
    return '''๐ **ูุตุงุฆุญ ุงูููุงุนูุฏ ุงูุทุจูุฉ:**

๐ **ุงูุจุญุซ ุนู ุทุจูุจ:**
โข ุงุณุชุฎุฏู ูุณู "ุงูุจุญุซ ุนู ุทุจูุจ" ูู ุงูุชุทุจูู
โข ุงูุฑุฃ ุชููููุงุช ุงููุฑุถู
โข ุชุฃูุฏ ูู ุงูุชุฎุตุต ุงูููุงุณุจ

๐ **ุงูุชุญุถูุฑ ููููุนุฏ:**
โข ุงูุชุจ ุฃุณุฆูุชู ูุณุจูุงู
โข ุฃุญุถุฑ ูุงุฆูุฉ ุจุฃุฏููุชู
โข ุณุฌู ุฃุนุฑุงุถู ูุชูุงุฑูุฎูุง

โฐ **ุฅุฏุงุฑุฉ ุงูููุงุนูุฏ:**
โข ุงุญุฌุฒ ููุงุนูุฏู ูุจูุฑุงู
โข ุงุตู ูุจู ุงูููุนุฏ ุจู15 ุฏูููุฉ
โข ุฃูุฏ ููุนุฏู ูุจู ููู

๐ **ุงููุชุงุจุนุฉ:**
โข ุงุญุชูุธ ุจุชูุงุฑูุฑู ุงูุทุจูุฉ
โข ุงุชุจุน ุชุนูููุงุช ุงูุทุจูุจ
โข ุงุญุฌุฒ ููุงุนูุฏ ุงููุชุงุจุนุฉ

ููููู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ูุญุฌุฒ ุงูููุงุนูุฏ ูุชุชุจุน ุชูุงุฑูุฑู ุงูุทุจูุฉ.''';
  }

  String _getDefaultResponse() {
    final responses = [
      '''ุดูุฑุงู ูู ุนูู ุณุคุงูู! ๐

ุฃูุง ููุง ููุณุงุนุฏุชู ูู:
โข ุชุญููู ุงูุฃุนุฑุงุถ ูุชูุฏูู ูุตุงุฆุญ ุนุงูุฉ
โข ูุนูููุงุช ุนู ุถุบุท ุงูุฏู ูุณูุฑ ุงูุฏู
โข ูุตุงุฆุญ ุงูุชุบุฐูุฉ ูุงูุฑูุงุถุฉ
โข ุฅุฑุดุงุฏุงุช ุงูุฃุฏููุฉ ูุงูุนูุงุฌ
โข ูุนูููุงุช ุนู ุงูููุงุนูุฏ ุงูุทุจูุฉ

ููููู ุฃูุถุงู ุงุณุชุฎุฏุงู ููุฒุงุช ุงูุชุทุจูู:
๐ ุชุณุฌูู ุงูููุงุณุงุช ุงูุทุจูุฉ
๐ ุงูุจุญุซ ุนู ุงูุฃุทุจุงุก
๐ ุญุฌุฒ ุงูููุงุนูุฏ
๐ ูุฑุงุฌุนุฉ ุงูุชูุงุฑูุฑ ุงูุตุญูุฉ

ููู ูููููู ูุณุงุนุฏุชู ุงููููุ''',
      
      '''ุฃููุงู ุจู! ๐

ูุณุช ูุชุฃูุฏุงู ูู ููู ุณุคุงูู ุจุงูุถุจุท. ูููููู ูุณุงุนุฏุชู ูู:

๐ฉบ **ุงูุตุญุฉ ุงูุนุงูุฉ:**
โข ุชุญููู ุงูุฃุนุฑุงุถ
โข ูุตุงุฆุญ ุงูููุงูุฉ
โข ูุนูููุงุช ุทุจูุฉ ุนุงูุฉ

๐ **ุฅุฏุงุฑุฉ ุงูุฃูุฑุงุถ ุงููุฒููุฉ:**
โข ุถุบุท ุงูุฏู
โข ุงูุณูุฑู
โข ุฃูุฑุงุถ ุงูููุจ

๐ฅ **ููุท ุงูุญูุงุฉ ุงูุตุญู:**
โข ุงูุชุบุฐูุฉ ุงูุณูููุฉ
โข ุงููุดุงุท ุงูุจุฏูู
โข ุฅุฏุงุฑุฉ ุงูุชูุชุฑ

ูู ููููู ุฅุนุงุฏุฉ ุตูุงุบุฉ ุณุคุงูู ุฃู ุฅุฎุจุงุฑู ุจูุง ุชุญุชุงุฌ ูุณุงุนุฏุฉ ููู ุชุญุฏูุฏุงูุ''',
    ];
    
    return responses[DateTime.now().millisecond % responses.length];
  }

  // Clear chat history
  Future<void> clearChatHistory(String userId) async {
    await _dbHelper.delete(
      'chat_messages',
      where: 'conversation_id = ?',
      whereArgs: [userId],
    );
  }

  // Get chat statistics
  Future<Map<String, int>> getChatStats(String userId) async {
    final db = await _dbHelper.database;
    
    final totalResult = await db.rawQuery(
      'SELECT COUNT(*) as count FROM chat_messages WHERE conversation_id = ?',
      [userId],
    );
    
    final userMessagesResult = await db.rawQuery(
      'SELECT COUNT(*) as count FROM chat_messages WHERE conversation_id = ? AND is_user_message = 1',
      [userId],
    );
    
    final aiMessagesResult = await db.rawQuery(
      'SELECT COUNT(*) as count FROM chat_messages WHERE conversation_id = ? AND is_user_message = 0',
      [userId],
    );

    return {
      'total': totalResult.first['count'] as int,
      'userMessages': userMessagesResult.first['count'] as int,
      'aiMessages': aiMessagesResult.first['count'] as int,
    };
  }
}
